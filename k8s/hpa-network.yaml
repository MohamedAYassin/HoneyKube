---
# HorizontalPodAutoscaler for Port Listeners
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: port-listener-apache-hpa
  namespace: honeykube
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: port-listener-apache
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: port-listener-wordpress-hpa
  namespace: honeykube
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: port-listener-wordpress
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: port-listener-nextjs-hpa
  namespace: honeykube
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: port-listener-nextjs
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
---
# HPA for LLM Planner
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: llm-planner-hpa
  namespace: honeykube
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: llm-planner
  minReplicas: 2
  maxReplicas: 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
---
# Network Policy - Allow only internal traffic to backend services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: honeykube-network-policy
  namespace: honeykube
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: honeykube
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic to port listeners from anywhere (honeypot exposure)
    - from: []
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 3000
    # Allow internal traffic between services
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: honeykube
      ports:
        - protocol: TCP
          port: 8081
        - protocol: TCP
          port: 8082
        - protocol: TCP
          port: 8083
        - protocol: TCP
          port: 6379
  egress:
    # Allow internal communication
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: honeykube
    # Allow external traffic for LLM API (OpenRouter)
    - to: []
      ports:
        - protocol: TCP
          port: 443
    # Allow DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
